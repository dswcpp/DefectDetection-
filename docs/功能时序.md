# 功能时序

## 1. 系统启动时序

```mermaid
sequenceDiagram
    autonumber
    participant Main as main()
    participant App as QApplication
    participant Cfg as ConfigManager
    participant Log as Logger
    participant CAM as CameraManager
    participant DET as DetectorPipeline
    participant PLC as PLCClient
    participant UI as MainWindow
    
    Main->>App: 创建 QApplication
    Main->>Log: 初始化日志系统
    Log-->>Main: spdlog ready
    
    Main->>Cfg: 加载配置文件
    Cfg->>Cfg: 解析 default.json
    Cfg->>Cfg: 校验参数合法性
    Cfg-->>Main: 配置就绪
    
    Main->>CAM: 初始化相机
    CAM->>CAM: 枚举设备
    CAM->>CAM: 打开相机
    CAM->>CAM: 设置曝光/增益
    CAM-->>Main: 相机就绪
    
    Main->>DET: 初始化检测器
    DET->>DET: 加载检测参数
    DET->>DET: 创建 ScratchDetector
    DET->>DET: 创建 CrackDetector
    DET->>DET: 创建 ForeignDetector
    DET->>DET: 创建 DimensionDetector
    DET->>DET: 加载 DNN 模型 (可选)
    DET-->>Main: 检测器就绪
    
    Main->>PLC: 连接 PLC
    PLC->>PLC: 建立 Modbus TCP 连接
    PLC->>PLC: 读取初始状态
    PLC-->>Main: PLC 连接成功
    
    Main->>UI: 创建主窗口
    UI->>UI: 初始化界面组件
    UI->>UI: 绑定信号槽
    UI-->>Main: 界面就绪
    
    Main->>App: exec() 进入事件循环
```

---

## 2. 单次检测时序

```mermaid
sequenceDiagram
    autonumber
    participant PLC as PLC
    participant IO as IOController
    participant CAM as Camera
    participant Q1 as 帧队列
    participant PIPE as DetectPipeline
    participant PRE as Preprocessor
    participant DET as Detectors
    participant SCORE as Scorer
    participant Q2 as 结果队列
    participant DB as Database
    participant UI as MainWindow
    
    PLC->>IO: 触发信号 (上升沿)
    IO->>IO: 去抖动 (5ms)
    IO->>CAM: 软触发采集
    
    CAM->>CAM: 曝光
    CAM->>CAM: 读取图像
    CAM->>Q1: 入队 cv::Mat
    
    Q1->>PIPE: 出队帧数据
    PIPE->>PRE: 预处理
    PRE->>PRE: 灰度化
    PRE->>PRE: 高斯滤波
    PRE->>PRE: ROI 裁剪
    PRE-->>PIPE: 返回处理后图像
    
    par 并行检测
        PIPE->>DET: ScratchDetector.detect()
        DET-->>PIPE: 划痕结果
    and
        PIPE->>DET: CrackDetector.detect()
        DET-->>PIPE: 裂纹结果
    and
        PIPE->>DET: ForeignDetector.detect()
        DET-->>PIPE: 异物结果
    and
        PIPE->>DET: DimensionDetector.detect()
        DET-->>PIPE: 尺寸结果
    end
    
    PIPE->>PIPE: 合并检测结果
    PIPE->>SCORE: 计算严重度评分
    SCORE->>SCORE: 特征量化
    SCORE->>SCORE: 加权融合
    SCORE->>SCORE: 分级判定
    SCORE-->>PIPE: 返回 severityScore + level
    
    PIPE->>Q2: 入队 DetectResult
    Q2->>DB: 异步保存结果
    Q2->>UI: 信号更新显示
    
    PIPE->>IO: 输出结果
    IO->>PLC: OK/NG 信号 (DO)
    
    Note over PLC,UI: 单次检测完成，总耗时 < 100ms
```

---

## 3. 图像采集线程时序

```mermaid
sequenceDiagram
    autonumber
    participant MAIN as 主线程
    participant ACQ as 采集线程
    participant CAM as ICamera
    participant Q as SPSCQueue<Mat>
    participant DET as 检测线程
    
    MAIN->>ACQ: start()
    
    loop 持续采集
        ACQ->>ACQ: 等待触发/连续模式
        ACQ->>CAM: grab(frame)
        
        alt 采集成功
            CAM-->>ACQ: frame (cv::Mat)
            ACQ->>ACQ: 检查图像质量
            
            alt 图像正常
                ACQ->>Q: push(frame)
                
                alt 队列已满
                    Q-->>ACQ: 丢弃最旧帧
                    ACQ->>ACQ: 记录丢帧日志
                end
            else 图像异常
                ACQ->>ACQ: 发送异常信号
                ACQ->>ACQ: 尝试调整曝光
            end
            
        else 采集失败
            CAM-->>ACQ: error
            ACQ->>ACQ: 重连计数++
            
            alt 重连次数 < 3
                ACQ->>CAM: reconnect()
            else 重连失败
                ACQ->>MAIN: emit fatalError()
            end
        end
        
        ACQ->>ACQ: feedWatchdog()
    end
```

---

## 4. 检测线程时序

```mermaid
sequenceDiagram
    autonumber
    participant Q1 as 帧队列
    participant DET as 检测线程
    participant PIPE as DetectPipeline
    participant TIMER as Timer
    participant Q2 as 结果队列
    participant WD as Watchdog
    
    loop 持续检测
        DET->>Q1: tryPop(frame, 100ms)
        
        alt 获取到帧
            Q1-->>DET: frame
            DET->>TIMER: start()
            DET->>PIPE: process(frame)
            
            PIPE-->>DET: DetectResult
            DET->>TIMER: stop()
            
            alt 耗时 > 阈值
                DET->>DET: 记录超时警告
            end
            
            DET->>Q2: push(result)
            DET->>WD: feedDog("detector")
            
        else 超时无帧
            Q1-->>DET: timeout
            DET->>WD: feedDog("detector")
            DET->>DET: 继续等待
        end
    end
```

---

## 5. 划痕检测算法时序

```mermaid
sequenceDiagram
    autonumber
    participant PIPE as Pipeline
    participant SD as ScratchDetector
    participant CV as OpenCV
    participant SCORE as DefectScorer
    
    PIPE->>SD: detect(image, roi)
    
    SD->>CV: Canny(image, edges, 50, 150)
    CV-->>SD: edges
    
    SD->>CV: getStructuringElement(RECT, 3x1)
    CV-->>SD: kernel
    
    SD->>CV: morphologyEx(edges, CLOSE, kernel)
    CV-->>SD: morphed
    
    SD->>CV: HoughLinesP(morphed, lines, ...)
    CV-->>SD: lines[]
    
    loop 遍历检测到的线段
        SD->>SD: 计算线段长度
        SD->>SD: 计算线段角度
        
        alt length > minLength && angle 合法
            SD->>SD: 添加到缺陷列表
            SD->>SD: 转换为 BoundingRect
        end
    end
    
    alt 检测到划痕
        SD->>SCORE: scoreScratch(totalLen, maxWidth, count)
        SCORE-->>SD: severityScore
        SD->>SCORE: classify(score)
        SCORE-->>SD: severityLevel
    end
    
    SD-->>PIPE: DetectResult
```

---

## 6. 裂纹检测算法时序

```mermaid
sequenceDiagram
    autonumber
    participant PIPE as Pipeline
    participant CD as CrackDetector
    participant CV as OpenCV
    participant XIMGPROC as cv::ximgproc
    participant SCORE as DefectScorer
    
    PIPE->>CD: detect(image, roi)
    
    CD->>CV: adaptiveThreshold(image, binary, ...)
    CV-->>CD: binary
    
    CD->>XIMGPROC: thinning(binary, skeleton, ZHANGSUEN)
    XIMGPROC-->>CD: skeleton
    
    CD->>CV: connectedComponentsWithStats(skeleton, ...)
    CV-->>CD: labels, stats, centroids, nLabels
    
    loop i = 1 to nLabels
        CD->>CD: 获取连通域面积
        CD->>CD: 计算骨架长度
        CD->>CD: 检测分叉点数量
        
        alt area > minArea
            CD->>CD: 添加到裂纹列表
            CD->>CD: 提取 BoundingRect
        end
    end
    
    alt 检测到裂纹
        CD->>SCORE: scoreCrack(length, branchCount, depth)
        SCORE-->>CD: severityScore
        CD->>SCORE: classify(score)
        SCORE-->>CD: severityLevel
    end
    
    CD-->>PIPE: DetectResult
```

---

## 7. DNN 推理时序

```mermaid
sequenceDiagram
    autonumber
    participant PIPE as Pipeline
    participant DNN as DnnDetector
    participant NET as cv::dnn::Net
    participant POST as PostProcessor
    
    PIPE->>DNN: detect(image, roi)
    
    DNN->>DNN: 裁剪 ROI
    DNN->>DNN: blobFromImage(cropped, blob, 1/255, 640x640)
    
    DNN->>NET: setInput(blob)
    DNN->>NET: forward(outputs)
    NET->>NET: 前向推理
    NET-->>DNN: outputs[]
    
    DNN->>POST: postProcess(outputs, imgSize)
    
    loop 遍历检测框
        POST->>POST: 解析 cx, cy, w, h
        POST->>POST: 提取 confidence
        POST->>POST: 获取 classId
        
        alt confidence > threshold
            POST->>POST: 坐标缩放
            POST->>POST: 添加到候选框列表
        end
    end
    
    POST->>POST: NMSBoxes(boxes, scores, 0.5, 0.4)
    POST-->>DNN: 过滤后的检测框
    
    DNN->>DNN: 构建 DetectResult
    DNN-->>PIPE: DetectResult
```

---

## 8. PLC 通信时序

```mermaid
sequenceDiagram
    autonumber
    participant APP as 应用程序
    participant PLC_T as PLC 通信线程
    participant MB as ModbusTCPClient
    participant PLC as PLC 设备
    
    Note over APP,PLC: 初始化连接
    APP->>PLC_T: start()
    PLC_T->>MB: connect(ip, port)
    MB->>PLC: TCP 三次握手
    PLC-->>MB: 连接成功
    MB-->>PLC_T: connected
    
    Note over APP,PLC: 轮询触发信号
    loop 每 10ms
        PLC_T->>MB: readRegister(40001)
        MB->>PLC: Modbus 读请求
        PLC-->>MB: 寄存器值
        MB-->>PLC_T: value
        
        alt value == 1 (触发)
            PLC_T->>APP: emit triggerReceived()
            PLC_T->>MB: writeRegister(40001, 0)
            MB->>PLC: 清除触发标志
        end
    end
    
    Note over APP,PLC: 写入检测结果
    APP->>PLC_T: setResult(result)
    PLC_T->>MB: writeRegister(40002, OK/NG)
    PLC_T->>MB: writeRegister(40003, defectType)
    PLC_T->>MB: writeRegister(40004, severityScore)
    MB->>PLC: Modbus 写请求
    PLC-->>MB: 写入成功
    
    Note over APP,PLC: 心跳保活
    loop 每 1s
        PLC_T->>MB: readRegister(40005)
        alt 读取失败
            PLC_T->>PLC_T: 重连
        end
    end
```

---

## 9. 配置热加载时序

```mermaid
sequenceDiagram
    autonumber
    participant FS as FileSystemWatcher
    participant CFG as ConfigManager
    participant VAL as Validator
    participant DET as Detectors
    participant UI as MainWindow
    
    FS->>FS: 监听 config/*.json
    
    Note over FS,UI: 配置文件被修改
    FS->>CFG: fileChanged(path)
    
    CFG->>CFG: 读取新配置
    CFG->>VAL: validate(newConfig)
    
    alt 校验通过
        VAL-->>CFG: valid
        CFG->>CFG: 备份旧配置
        CFG->>CFG: 应用新配置
        
        CFG->>DET: updateParams(scratc_params)
        CFG->>DET: updateParams(crack_params)
        CFG->>DET: updateParams(foreign_params)
        CFG->>DET: updateParams(dimension_params)
        
        CFG->>UI: emit configReloaded()
        UI->>UI: 更新参数面板显示
        
    else 校验失败
        VAL-->>CFG: invalid + reason
        CFG->>UI: emit configError(reason)
        UI->>UI: 显示错误提示
    end
```

---

## 10. 异常恢复时序

```mermaid
sequenceDiagram
    autonumber
    participant WD as Watchdog
    participant PIPE as Pipeline
    participant CAM as Camera
    participant PLC as PLCClient
    participant UI as MainWindow
    participant LOG as Logger
    
    Note over WD,LOG: 检测到相机超时
    WD->>WD: 检测到 camera 模块超时
    WD->>PIPE: emit moduleTimeout("camera")
    
    PIPE->>LOG: error("相机超时")
    PIPE->>UI: emit warning("相机连接异常")
    
    PIPE->>PIPE: 进入恢复模式
    PIPE->>CAM: close()
    PIPE->>PIPE: sleep(1000ms)
    
    loop 重试 3 次
        PIPE->>CAM: reconnect()
        
        alt 重连成功
            CAM-->>PIPE: success
            PIPE->>LOG: info("相机恢复")
            PIPE->>UI: emit recovered("camera")
            PIPE->>PIPE: 恢复正常检测
        else 重连失败
            CAM-->>PIPE: failed
            PIPE->>PIPE: sleep(2000ms)
        end
    end
    
    alt 3 次重连全部失败
        PIPE->>LOG: fatal("相机无法恢复")
        PIPE->>PLC: setStatus(FAULT)
        PIPE->>UI: emit fatalError("请检查相机连接")
        PIPE->>PIPE: 安全停机
    end
```

---

## 11. 系统关闭时序

```mermaid
sequenceDiagram
    autonumber
    participant UI as MainWindow
    participant PIPE as Pipeline
    participant ACQ as 采集线程
    participant DET as 检测线程
    participant PLC as PLCClient
    participant CAM as Camera
    participant DB as Database
    participant LOG as Logger
    
    UI->>UI: closeEvent()
    UI->>UI: 弹出确认对话框
    
    alt 用户确认关闭
        UI->>PIPE: stop()
        
        PIPE->>ACQ: requestStop()
        PIPE->>DET: requestStop()
        
        par 等待线程退出
            ACQ->>ACQ: 退出循环
            ACQ-->>PIPE: 线程结束
        and
            DET->>DET: 处理完当前帧
            DET->>DET: 退出循环
            DET-->>PIPE: 线程结束
        end
        
        PIPE->>PLC: setStatus(OFFLINE)
        PIPE->>PLC: disconnect()
        PLC-->>PIPE: 断开连接
        
        PIPE->>CAM: close()
        CAM-->>PIPE: 相机关闭
        
        PIPE->>DB: flush()
        PIPE->>DB: close()
        DB-->>PIPE: 数据库关闭
        
        PIPE->>LOG: info("系统正常关闭")
        PIPE->>LOG: flush()
        
        PIPE-->>UI: 关闭完成
        UI->>UI: accept() 关闭窗口
    else 用户取消
        UI->>UI: ignore() 取消关闭
    end
```

---

## 12. 多工位协同时序

```mermaid
sequenceDiagram
    autonumber
    participant PLC as PLC
    participant S1 as 工位1 (正面)
    participant S2 as 工位2 (反面)
    participant S3 as 工位3 (侧面)
    participant AGG as ResultAggregator
    participant OUT as 输出控制
    
    PLC->>S1: 触发信号
    PLC->>S2: 触发信号
    PLC->>S3: 触发信号
    
    par 并行检测
        S1->>S1: 采集 + 检测
        S1-->>AGG: Result1 {defects, score}
    and
        S2->>S2: 采集 + 检测
        S2-->>AGG: Result2 {defects, score}
    and
        S3->>S3: 采集 + 检测
        S3-->>AGG: Result3 {defects, score}
    end
    
    AGG->>AGG: 等待所有结果 (timeout: 200ms)
    
    alt 所有工位返回
        AGG->>AGG: 合并缺陷列表
        AGG->>AGG: 取最高严重度
        AGG->>AGG: 综合判定 OK/NG
        
        alt 任一工位 NG
            AGG->>OUT: 剔除信号
            OUT->>PLC: NG
        else 全部 OK
            AGG->>OUT: 放行信号
            OUT->>PLC: OK
        end
        
    else 部分工位超时
        AGG->>AGG: 记录超时工位
        AGG->>OUT: 异常信号
        OUT->>PLC: ERROR
    end
```