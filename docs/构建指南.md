# 构建指南

## 1. 环境准备

### 1.1 依赖清单

| 依赖 | 版本 | 必需 | 说明 |
| --- | --- | --- | --- |
| **Qt** | 6.5+ | ✅ | GUI 框架 |
| **OpenCV** | 4.6+ | ✅ | 图像处理 |
| **spdlog** | 1.10+ | ✅ | 日志库 |
| **nlohmann/json** | 3.11+ | ✅ | JSON 解析 |
| **libmodbus** | 3.1+ | ⚪ | PLC 通信 |
| **cpp-httplib** | 0.12+ | ⚪ | HTTP 服务 |
| **海康 MVS SDK** | 3.x | ⚪ | 海康相机 |
| **大恒 Galaxy SDK** | 2.x | ⚪ | 大恒相机 |

---

## 2. Ubuntu 构建

### 2.1 安装系统依赖

```bash
# 基础开发工具
sudo apt update
sudo apt install -y build-essential cmake git

# Qt6
sudo apt install -y qt6-base-dev qt6-tools-dev libqt6charts6-dev

# OpenCV
sudo apt install -y libopencv-dev

# 其他依赖
sudo apt install -y libmodbus-dev libspdlog-dev nlohmann-json3-dev
```

### 2.2 编译项目

```bash
# 克隆代码
git clone [https://github.com/your-org/defect-detection.git](https://github.com/your-org/defect-detection.git)
cd defect-detection

# 创建构建目录
mkdir build && cd build

# 配置（Release 模式）
cmake .. -DCMAKE_BUILD_TYPE=Release

# 编译（8 线程）
cmake --build . -j8

# 安装
sudo cmake --install .
```

### 2.3 CMake 选项

| 选项 | 默认值 | 说明 |
| --- | --- | --- |
| `CMAKE_BUILD_TYPE` | Release | Debug/Release/RelWithDebInfo |
| `ENABLE_DNN` | ON | 启用深度学习模块 |
| `ENABLE_HIK_CAMERA` | OFF | 启用海康相机支持 |
| `ENABLE_DAHENG_CAMERA` | OFF | 启用大恒相机支持 |
| `ENABLE_TESTS` | ON | 构建单元测试 |
| `ENABLE_BENCHMARK` | OFF | 构建性能测试 |

```bash
# 示例：启用海康相机支持
cmake .. -DENABLE_HIK_CAMERA=ON -DHIK_SDK_PATH=/opt/MVS
```

---

## 3. Windows 构建

### 3.1 安装依赖 (vcpkg)

```powershell
# 安装 vcpkg
git clone [https://github.com/microsoft/vcpkg.git](https://github.com/microsoft/vcpkg.git)
cd vcpkg
.\bootstrap-vcpkg.bat

# 安装依赖
.\vcpkg install qt6:x64-windows opencv4:x64-windows spdlog:x64-windows nlohmann-json:x64-windows
```

### 3.2 编译项目

```powershell
# 配置
mkdir build && cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

# 编译
cmake --build . --config Release
```

### 3.3 Visual Studio 构建

1. 打开 CMake GUI
2. 设置源码路径和构建路径
3. 点击 Configure → 选择 Visual Studio 2019/2022
4. 点击 Generate
5. 点击 Open Project 打开 VS 解决方案
6. 选择 Release 配置，生成解决方案

---

## 4. 交叉编译 (ARM)

### 4.1 RK3399 / aarch64

```bash
# 安装交叉编译工具链
sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

# 配置
cmake .. \
  -DCMAKE_TOOLCHAIN_FILE=../platform/rk3399/toolchain.cmake \
  -DCMAKE_BUILD_TYPE=Release

# 编译
cmake --build . -j8
```

### 4.2 工具链文件示例

```
# platform/rk3399/toolchain.cmake
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR aarch64)

set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)

set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
```

---

## 5. 常见问题

### Q1: Qt6 找不到

```bash
# 设置 Qt6 路径
export Qt6_DIR=/opt/Qt/6.5.0/gcc_64/lib/cmake/Qt6
cmake .. -DQt6_DIR=$Qt6_DIR
```

### Q2: OpenCV 版本过低

```bash
# 从源码编译 OpenCV 4.6
git clone -b 4.6.0 [https://github.com/opencv/opencv.git](https://github.com/opencv/opencv.git)
cd opencv && mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_opencv_dnn=ON
cmake --build . -j8
sudo cmake --install .
```

### Q3: 海康相机 SDK 路径

```bash
# 默认安装路径
# Linux: /opt/MVS
# Windows: C:\Program Files (x86)\MVS

cmake .. -DHIK_SDK_PATH=/opt/MVS
```

---

## 6. 构建产物

```
build/
├── bin/
│   ├── defect-detection      # 主程序
│   └── defect-detection-cli  # 命令行工具
├── lib/
│   ├── libdetect_[core.so](http://core.so)     # 核心库
│   └── libdetect_[hal.so](http://hal.so)      # HAL 库
└── tests/
    ├── test_detectors        # 检测器测试
    └── bench_pipeline        # 性能测试
```